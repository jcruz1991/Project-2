/* jshint browser: true, jquery: true, camelcase: true, indent: 2, undef: true, quotmark: single, maxlen: 80, trailing: true, curly: true, eqeqeq: true, forin: true, immed: true, latedef: true, newcap: true, nonew: true, unused: true, strict: true */

//client side javascript
 /* CPSC 473 Project 1: Filmder (Should I watch this?)
  Submitted by- Team- Oscillatory Memorization
  Email- supra.chavan@gmail.com
 */

 /**
 * Sign up functionality for first time user
 * Submits sign up form data to server as JSON
 * Input- Username, Email address, password
 * Output- on success, returns JSON message that user is added successfully.
 */
var callSignUpFunction = function(){
  'use strict';
  var uname = document.getElementsByName('uname')[0].value;
  var email = document.getElementsByName('email')[0].value;
  var pwd1 = document.getElementsByName('pwd1')[0].value;
  var jsonStr = JSON.stringify({'username': uname,
                                'email': email,
                                'password': pwd1});
  $.ajax({
    type: 'POST',
    data: jsonStr,
    dataType: 'json',
    contentType: 'application/json',
    url: 'http://localhost:3000/signup',            
    success: function(data) {
                            console.log('success');
                            console.log(jsonStr);
                            console.log(JSON.stringify(data));
                            console.log(data);
                            $('.result').html(data);
                            $('.signup_form').trigger('reset');
                            $('login_modal').modal('destroy');
    } //end success
  }); //end ajax
}; //end function

/**
 * Log in functionality for registered user
 * Submits login form data to server as JSON
 * Input- Username, password
 * Output- on success, diplays user profile, 
 * returns user id generated by MongoDB
 */
var callLogInFunction = function(){
  'use strict';
  var ulname = document.getElementsByName('ulname')[0].value;
  var pwd = document.getElementsByName('pwd')[0].value;
  var jsonStr = JSON.stringify({'username1': ulname, 'password1': pwd});

  $.ajax({
        type: 'POST',
        data: jsonStr,
        dataType: 'json',
        contentType: 'application/json',
        url: 'http://localhost:3000/login',            
        success: function(data) {
                                console.log('success');
                                console.log(jsonStr);
                                console.log(JSON.stringify(data));
                                console.log(data);

                                if(data.error){
                                  $('.result2').html(data.error);
                                  $('.login_form').trigger('reset');
                                }
                                else{  //successful log in
                                  $('.result2').html(data);
                                  $('.login_form').trigger('reset');
                                  $('.login_modal').modal('hide');

                                  $('.right_menu1').hide();
                                  $('.pointing.label').text(
                                  'Welcome '+data.username);

                                  $('.userHeader').text('Welcome '+data.username);
                                  $('.userId').text(data.userid);
                                  console.log(data.userid);
                                  $('.userId').hide();

                                  $('.right_menu2').show();
                                  // $('.login_seg').show();
                                  // $('.main_seg').hide();
                                  // $('.movie_seg').hide();
                                  $('.ui.sidebar').sidebar('toggle');
                                } //end else
        } //end success
      }); //end ajax
}; //end function

/**
 * Add movies functionality for logged in user
 * Submits  add movies form data to server as JSON
 * Input- Moviename, user id
 * Output- on success, returns JSON message that movie is added successfully.
 */
var callAddItemFunction = function() {
  'use strict';
  
  var itemName = document.getElementsByName('itemname')[0].value;
  var itemPrice = document.getElementsByName('itemprice')[0].value;
  var itemDescription = $('.itemDescription').val();
  var itemType = $('.selectType option:selected').text();
  var userID = $('span.userId').text();
  console.log(userID);
  console.log('type: '+itemType);
  var jsonStr = JSON.stringify({'itemName': itemName, 
  								'itemPrice':itemPrice,
  								'itemDescription':itemDescription,
  								'itemType':itemType,
                                'userId': userID});
  $.ajax({
          type: 'POST',
          data: jsonStr,
          dataType: 'json',
          contentType: 'application/json',
          url: 'http://localhost:3000/additems',            
          success: function(data) {
                                  $('.result3').html(data);
                                  $('.additem_form').trigger('reset');
                                  $('.result3').html();
          } //end success
  }); //end ajax
}; //end function

var main = function(){

	$('.right_menu2').hide();
    $('.right_menu1').show();
    $('.ui.sidebar').sidebar('toggle');

	$('.logout').click(function(){

    $('.right_menu2').hide();
    $('.right_menu1').show();
    // $('.login_seg').hide();
    // $('.main_seg').show();
    $('span.userId').empty();
    // $('.right_menu3').hide();

  });

	$('.addItem').click(function(){
		$('.result3').empty();
    	$('.additem_modal').modal('show');
    	$('.selectType').dropdown();

	});

	$('.signup').click(function () {
    $('.result').empty();
    $('.signup_modal').modal('show');
  });

  $('.login').click(function () {
    $('.result2').empty();
    $('.login_modal').modal('show');
  });

  $('.login').on('click', function(){
    $('signup_modal').modal('hide');
    $('login_modal').modal('show');
  });

  $('.signup').on('click', function(){
    $('signup_modal').modal('show');
    $('login_modal').modal('hide');
  });

  $('.login_form').form({
    fields: {
      ulname: {
        identifier : 'ulname',
        rules: [
          {
            type   : 'empty',
            prompt : 'Please enter a username'
          }
        ]
      },
      pwd: {
            identifier : 'pwd',
            rules: [
              {
                type   : 'empty',
                prompt : 'Please enter a password'
              }
            ]
          },
    },  //end fields
    onSuccess: function(event) {
      callLogInFunction();
      event.preventDefault();
      console.log('form valid');
      $('.result3').empty();
    } //end onSuccess
  }); //end login form validation

  $('.signup_form').form({ 
    fields: {
            username: {
              identifier : 'uname',
              rules: [
                {
                  type   : 'empty',
                  prompt : 'Please enter a username'
                }
              ]
            },
          email: {
            identifier : 'email',
            rules: [
                    {
                      type   : 'email',
                      prompt : 'Please enter a valid email address'
                    },
            ]
          },
          pwd1: {
            identifier : 'pwd1',
            rules: [
                    {
                      type   : 'empty',
                      prompt : 'Please enter a password'
                    },
                    {
                      type   : 'length['+6+']',
                      prompt : 'Your password must be at least 6 characters'
                    }
            ]
          },
          pwd2: {
            identifier : 'pwd2',
            rules: [
                    {
                      type   : 'empty',
                      prompt : 'Please enter a password'
                    },
                    {
                      type   : 'length['+6+']',
                      prompt : 'Your password must be at least 6 characters'
                    },
                    {
                      type   : 'match[pwd1]',
                      prompt : 'Passwords do not match'
                    }
            ]
          }
          // chck: {
          //   identifier : 'chck',
          //   rules: [
          //     {
          //       type   : 'checked',
          //       prompt : 'You must agree to the terms and conditions'
          //     }
          //   ]
          // }
    }, //end fields
    onSuccess: function(event) {
      callSignUpFunction();
      event.preventDefault();
      console.log('form valid');  
    } //end onSuccess
  }); //end signup form validation
  $('.additem_form').form({
    // $('.result3').html();
    fields: {
      itemname: {
          identifier : 'itemname',
          rules: [
                  {
                    type   : 'empty',
                    prompt : 'This field cannot be empty'
                  }
          ]
      },
      itemprice: {
          identifier : 'itemprice',
          rules: [
                  {
                    type   : 'empty',
                    prompt : 'This field cannot be empty'
                  }
          ]
      }
    }, //end fields  
    onSuccess: function(event) {
      callAddItemFunction();
      event.preventDefault();
      console.log('form valid');
     
    } //end onSuccess
  }); //end add item form validation

}; //end main


$(document).ready(main);
